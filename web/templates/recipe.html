{% extends "base.html" %}
{% block content %}
    {% if recipe.servings %}
        <div class="recipe-servings"
             {% if servings_is_int %}data-base-servings="{{ servings_value }}"{% endif %}>
            <span class="recipe-servings-label">Serves</span>
            {% if servings_is_int %}
                <div class="recipe-servings-controls">
                    <button class="servings-button"
                            type="button"
                            data-delta="-1"
                            aria-label="Decrease servings">-</button>
                    <span class="recipe-servings-value">{{ servings_display }}</span>
                    <button class="servings-button"
                            type="button"
                            data-delta="1"
                            aria-label="Increase servings">+</button>
                </div>
            {% else %}
                <span class="recipe-servings-value">{{ servings_display }}</span>
            {% endif %}
        </div>
    {% endif %}
    {% if ingredients %}
        <h2>Ingredients</h2>
        <ul class="recipe-ingredients">
            {% for item in ingredients %}
                <li class="recipe-ingredient"
                    data-qty-value="{{ item.qty_value if item.qty_value is not none else '' }}"
                    data-qty-display="{{ item.qty_display }}"
                    data-fixed="{{ 'true' if item.fixed else 'false' }}">
                    <div class="ingredient-row">
                        {% if item.ref_url %}
                            <a class="ingredient-name ingredient-link" href="{{ item.ref_url }}">{{ item.name }}</a>
                        {% else %}
                            <span class="ingredient-name">{{ item.name }}</span>
                        {% endif %}
                        <span class="ingredient-qty">
                            {% if item.qty_display %}{{ item.qty_display }}{% endif %}
                        </span>
                        <span class="ingredient-unit">
                            {% if item.unit %}{{ item.unit }}{% endif %}
                        </span>
                    </div>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <h2>Ingredients</h2>
        <p>No ingredients listed.</p>
    {% endif %}
    {% if steps %}
        <h2>Steps</h2>
        <div class="recipe-steps">
            {% for item in steps %}
                {% if item.kind == "step" %}
                    <div class="recipe-step">
                        <span class="step-number">{{ item.number }}</span>
                        {% if item.ingredients %}
                            <div class="step-ingredients">
                                {% for ingredient in item.ingredients -%}
                                    <span class="step-ingredient{% if not loop.last %} step-ingredient--sep{% endif %}"
                                          data-name="{{ ingredient.name }}"
                                          data-qty-display="{{ ingredient.qty_display }}"
                                          data-qty-value="{{ ingredient.qty_value if ingredient.qty_value is not none else '' }}"
                                          data-unit="{{ ingredient.unit }}"
                                          data-fixed="{{ 'true' if ingredient.fixed else 'false' }}"
                                          data-ref-url="{{ ingredient.ref_url }}"></span>
                                {%- endfor %}
                            </div>
                        {% endif %}
                        <div class="step-text">{{ item.text }}</div>
                    </div>
                {% else %}
                    <div class="recipe-note">
                        <span class="note-text">{{ item.text }}</span>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    {% else %}
        <h2>Steps</h2>
        <p>No steps yet.</p>
    {% endif %}
    <script>
(() => {
  const container = document.querySelector('.recipe-servings');
  const baseServings = Number(container?.dataset.baseServings);
  const valueEl = container?.querySelector('.recipe-servings-value');
  const buttons = container ? Array.from(container.querySelectorAll('.servings-button')) : [];

  const items = Array.from(document.querySelectorAll('.recipe-ingredient')).map((item) => {
    const qtySpan = item.querySelector('.ingredient-qty');
    const rawValue = item.dataset.qtyValue;
    return {
      qtySpan,
      qtyValue: rawValue === '' ? NaN : Number(rawValue),
      qtyDisplay: item.dataset.qtyDisplay || (qtySpan ? qtySpan.textContent.trim() : ''),
      fixed: item.dataset.fixed === 'true',
    };
  });

  const stepItems = Array.from(document.querySelectorAll('.step-ingredient')).map((item) => {
    const rawValue = item.dataset.qtyValue;
    return {
      el: item,
      name: item.dataset.name || '',
      unit: item.dataset.unit || '',
      qtyValue: rawValue === '' ? NaN : Number(rawValue),
      qtyDisplay: item.dataset.qtyDisplay || '',
      fixed: item.dataset.fixed === 'true',
      refUrl: item.dataset.refUrl || '',
    };
  });

  const formatDecimal = (value) => {
    const rounded = Math.round(value * 100) / 100;
    let text = rounded.toFixed(2);
    text = text.replace(/\.00$/, '').replace(/(\.\d)0$/, '$1');
    return text;
  };

  const formatStepText = (item, scale) => {
    const name = item.name;
    let amount = '';
    if (item.fixed || !Number.isFinite(item.qtyValue)) {
      amount = item.qtyDisplay || '';
    } else {
      amount = formatDecimal(item.qtyValue * scale);
    }
    if (amount && item.unit) {
      amount = `${amount}\u00a0${item.unit}`;
    } else if (!amount && item.unit) {
      amount = item.unit;
    }
    return amount ? `${name} ${amount}` : name;
  };

  const renderStepIngredients = (scale) => {
    for (const item of stepItems) {
      const text = formatStepText(item, scale);
      if (item.refUrl) {
        let link = item.el.querySelector('a');
        if (!link) {
          link = document.createElement('a');
          link.className = 'ingredient-link';
          item.el.textContent = '';
          item.el.append(link);
        }
        link.href = item.refUrl;
        link.textContent = text;
      } else {
        item.el.textContent = text;
      }
    }
  };

  const update = (nextServings) => {
    if (!Number.isFinite(nextServings) || nextServings <= 0) return;
    const scale = nextServings / baseServings;
    for (const item of items) {
      if (!item.qtySpan) continue;
      if (item.fixed || !Number.isFinite(item.qtyValue)) {
        item.qtySpan.textContent = item.qtyDisplay;
        continue;
      }
      item.qtySpan.textContent = formatDecimal(item.qtyValue * scale);
    }
    renderStepIngredients(scale);
  };

  renderStepIngredients(1);
  if (!container || !valueEl || buttons.length === 0) return;
  if (!Number.isFinite(baseServings) || baseServings <= 0) return;

  for (const button of buttons) {
    button.addEventListener('click', () => {
      const delta = Number(button.dataset.delta || '0');
      const current = Number(valueEl.textContent || '');
      if (!Number.isFinite(delta) || !Number.isFinite(current)) return;
      const nextServings = Math.max(1, current + delta);
      valueEl.textContent = String(nextServings);
      update(nextServings);
    });
  }
})();
    </script>
{% endblock %}
